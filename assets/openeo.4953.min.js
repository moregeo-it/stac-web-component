(self["webpackChunkvue_lib_openeo"]=self["webpackChunkvue_lib_openeo"]||[]).push([[4953],{3617:(e,t,s)=>{var i=s(9541);i.__esModule&&(i=i.default),"string"===typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals);var r=s(9547).A;e.exports.__inject__=function(e){r("4e1b47aa",i,e)}},4953:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>$});var i=function(){var e=this,t=e._self._c;return t("div",{ref:"div",class:e.classes,style:e.style,attrs:{id:e.id,tabindex:"0"},on:{mousemove:e.onMouseMove,mousedown:e.onMouseDown,wheel:e.onMouseWheel,keydown:e.onKeyDown,focus:function(t){e.hasFocus=!0},blur:function(t){e.hasFocus=!1}}},[t("svg",{staticClass:"canvas",attrs:{xmlns:"http://www.w3.org/2000/svg",version:"1.1"}},[e._l(e.edges,function(s){return t("Edge",{key:s.id,attrs:{id:s.id,parameter1:s.parameter1,parameter2:s.parameter2,selected:s.selected,inactive:s.inactive,issues:s.issues,state:e.state},on:{mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s),position:function(t){return e.updateEdgePos(s,arguments)}}})}),e._l(e.hiddenParameterRefEdges,function(s){return t("Edge",{key:s.id,attrs:{id:s.id,parameter1:s.parameter1,parameter2:s.parameter2,inactive:!0,lineColor:[200,200,200,1],lineWidth:2,state:e.state},on:{mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s)}})}),e.linkingLine?t("line",e._b({},"line",e.linkingLine,!1)):e._e(),e.selectRect?t("rect",e._b({},"rect",e.selectRect,!1)):e._e()],2),t("div",{staticClass:"blocks"},e._l(e.blocks,function(s){return t("Block",{key:s.id,attrs:{id:s.id,type:s.type,spec:s.spec,state:e.state,selected:s.selected,position:s.position,origin:s.origin,process_id:s.process_id,namespace:s.namespace,result:s.result,args:s.arguments,description:s.description},on:{update:(...t)=>e.updateBlock(s,...t),mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s),move:e.startDragBlock}})}),1),e.state.scale<.7||e.showZoomInfo?t("div",{staticClass:"zoomInfo"},[e.state.scale<.7?t("div",[e._v(" Zoom in for more details. ")]):e._e(),e.showZoomInfo?t("div",[e._v(" Zoom with "),t("kbd",[e._v("STRG")]),e._v(" or "),t("kbd",[e._v("Meta")]),e._v(" key and the mouse wheel. ")]):e._e()]):e._e(),e.parameterViewer?t("ParameterViewer",e._b({on:{close:function(t){e.parameterViewer=null}}},"ParameterViewer",e.parameterViewer,!1)):e._e()],1)},r=[],o=s(1284),a=s(4949),n=s(6189),l=s(1572),c=s(4894),h=s(5471),d=s(1974),p=s.n(d),u=s(9985),m=s.n(u),g=s(7911);const f=function(e){return h.Ay.observable({root:e,editable:!1,compactMode:!1,moving:null,selecting:null,center:[0,0],mouse:[0,0],scale:g.A.defaultScale,linkFrom:null,linkTo:null})},y=20,b=function(e,t){Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every((e,s)=>e.id===t[s].id)||this.$emit("selectionChanged",this.selectedBlocks,this.selectedEdges)},k={name:"ModelBuilder",components:{Block:o.A,Edge:a.A,ParameterViewer:()=>Promise.all([s.e(5523),s.e(3705)]).then(s.bind(s,3705))},props:{id:{type:String,required:!0},editable:{type:Boolean,default:!1},value:{type:Object,default:()=>({})},collections:{type:Array,default:()=>[]},processes:{type:[Array,Object],default:()=>[]},parent:{type:Object,default:null},parentSchema:{type:Object,default:null},historySize:{type:Number,default:30},explicitZoom:{type:Boolean,default:!1},height:{type:String,default:null}},data(){return{isMounted:!1,allMounted:!1,newBlockOffset:0,history:[],historyPointer:null,process:Object.freeze(this.value),blocks:[],edges:[],hiddenParameterRefEdges:{},processGraph:null,nextBlockId:1,nextEdgeId:1,clipboard:null,activeTransactions:0,hasFocus:!1,linkingLine:null,parameterViewer:null,showZoomInfo:this.explicitZoom,state:f(this)}},computed:{style(){let e={};return"string"===typeof this.height&&(e.height=this.height),e},classes(){let e=["vue-component","model-builder"];return this.hasFocus&&e.push("focus"),this.editable&&e.push("editable"),this.state.compactMode&&e.push("compact"),this.state.scale<.5?e.push("scale_xs"):this.state.scale<.7?e.push("scale_s"):this.state.scale<.9?e.push("scale_m"):this.state.scale<1.1?e.push("scale_l"):e.push("scale_xl"),e},selectRect(){return this.state.selecting?{x:Math.min(this.state.selecting.current[0],this.state.selecting.start[0]),y:Math.min(this.state.selecting.current[1],this.state.selecting.start[1]),width:Math.abs(this.state.selecting.current[0]-this.state.selecting.start[0]),height:Math.abs(this.state.selecting.current[1]-this.state.selecting.start[1]),stroke:"rgba(0,0,0,0.8)","stroke-width":1,fill:"rgba(0,0,0,0.05)"}:null},processRegistry(){if(this.processes instanceof l.ProcessRegistry||"function"===typeof this.processes.count&&"function"===typeof this.processes.get)return this.processes;if(Array.isArray(this.processes))return new l.ProcessRegistry(this.processes);throw new Error("Invalid processes specified, must be ProcessRegistry or Array")},hasProcesses(){return this.processRegistry.count()>0},processBlocks(){return this.blocks.filter(e=>"process"===e.type)},selectedBlocks(){return this.blocks.filter(e=>e.selected)},selectedEdges(){return this.edges.filter(e=>e.selected)},selectedSideEdge(){return 1===this.selectedEdges.length&&this.selectedEdges[0].selectedParameter?this.selectedEdges[0]:null},hasSelection(){return this.selectedBlocks.length>0||this.selectedEdges.length>0},processParametersFromSchemas(){let e=[];this.parent&&this.parent.$parent&&"function"===typeof this.parent.$parent.getPgParameters&&(e=this.parent.$parent.getPgParameters().map(e=>e.spec));let t=[];this.parentSchema&&(t=this.parentSchema.getCallbackParameters());let s=e.filter(e=>!t.find(t=>e.name===t.name));return t.concat(s)}},watch:{parentSchema(){this.importPgParameters(this.processParametersFromSchemas,"schema")},async value(e){this.allMounted&&(e instanceof v||(this.process=e,await this.import(e,{propagate:!1,undoOnError:!1})))},editable:{immediate:!0,handler(e){this.state.editable=e}},selectedEdges:b,selectedBlocks:b,allMounted(){this.updateHiddenParameterRefEdges()},isMounted(){this.checkAllMounted()}},beforeCreate(){n.A.enableHtmlProps(this)},async created(){this.supports("error")||this.$on("error",(e,t=null)=>console.error(e,t)),this.supports("editArguments")||this.$on("editArguments",(...e)=>this.showParameterViewer(...e)),this.$on("duplicate",this.duplicate.bind(this))},async mounted(){n.A.loadFontAwesome(this),this.moveCenter(0,0,!0),this.onDocumentMouseUpFn=this.onDocumentMouseUp.bind(this),document.addEventListener("mouseup",this.onDocumentMouseUpFn),await this.importPgParameters(this.processParametersFromSchemas,"schema"),await this.import(this.value,{propagate:!1,undoOnError:!1})||this.perfectScale(),b.bind(this)(),this.isMounted=!0},beforeDestroy(){document.removeEventListener("mouseup",this.onDocumentMouseUpFn)},methods:{updateEdgePos(e,t){e.position1=t[0],e.position2=t[1]},mount(e,t=null){e.$el=t,this.checkAllMounted()},checkAllMounted(){this.isMounted?this.allMounted=!this.blocks.find(e=>!e.$el)||!this.edges.find(e=>!e.$el):this.allMounted=!1},updateBlockArguments(e,t,s){s.length>0&&this.parameterRemoved(e,s),this.$set(e,"arguments",t),this.commit(),s.length>0&&this.$nextTick(()=>this.refreshEdges())},updateBlockDescription(e,t){this.$set(e,"description",t),this.commit()},updateBlockPos(e,t,s=!0){this.$set(e,"position",t),this.commit(null,s,!1)},updateBlockResult(e,t){this.$set(e,"result",t),this.commit()},updateBlockSelected(e,t,s=!0){s&&this.unselectAll(),this.$set(e,"selected",t),this.commit(null,!1,!1)},updateBlockSpec(e,t){let s=["name","schema","description","optional","deprecated","experimental","default"],i=n.A.omitFromObject(e.spec,s);Object.assign(i,t),i.optional||(delete i.optional,delete i.default),i.deprecated||delete i.deprecated,i.experimental||delete i.experimental,this.$set(e,"spec",i),this.commit()},updateBlock(e,t,s,i){switch(t){case"arguments":this.updateBlockArguments(e,s,i);break;case"description":this.updateBlockDescription(e,s);break;case"position":this.updateBlockPos(e,s,i);break;case"result":this.setResultNode(e,s);break;case"selected":this.updateBlockSelected(e,s,i);break;case"spec":this.updateBlockSpec(e,s);break}},updateHiddenParameterRefEdges(){if(!this.hasProcesses||!this.allMounted||!this.blocks.find(e=>"parameter"===e.type))return void(this.hiddenParameterRefEdges={});let e={};for(let s of this.processBlocks)for(let i in s.arguments){let r=s.arguments[i];if(!n.A.isObject(r)||!n.A.isObject(r.process_graph))continue;let o=c.Utils.getRefs(r,!0,!0).filter(e=>"undefined"!==typeof e.from_parameter);for(let a of o)try{if(!s.$el)continue;if(s.$el.isParameterScoped(i,a.from_parameter))continue;let t=this.getPgParameterById("$"+a.from_parameter);if(!t)continue;let r=t.$el.getBlockParameter("output"),o=s.$el.getBlockParameter(i),n=`${t.id}->${s.id}:${i}`;r&&o&&(this.hiddenParameterRefEdges[n]?e[n]=this.hiddenParameterRefEdges[n]:e[n]={$el:null,id:n,parameter1:r,parameter2:o})}catch(t){console.warn(t)}}this.hiddenParameterRefEdges=e},parameterRemoved(e,t){for(let s of this.edges.slice(0))s.parameter2.$parent.id===e.id&&t.includes(s.parameter2.name)&&this.removeEdge(s)},startDragBlock(e){for(let t of this.blocks)t.$el&&t.$el.startDrag(e)},refreshEdges(){this.refreshEdgesFor(this.edges),this.refreshEdgesFor(Object.values(this.hiddenParameterRefEdges))},refreshEdgesFor(e){for(let t of e)t.$el&&t.$el.updatePositions()},supports(e){return Boolean(this.$listeners&&this.$listeners[e])},focus(){this.$refs.div.focus()},link(e){this.state.linkFrom?this.state.linkTo=e:this.state.linkFrom=e},unlink(e=null){e?this.state.linkTo==e?this.state.linkTo=null:this.state.linkFrom==e&&(this.state.linkFrom=null,this.linkingLine=null):(this.state.linkTo=null,this.state.linkFrom=null,this.linkingLine=null)},multiSelect(){let e=this.selectRect;this.blocks.filter(t=>{if(Array.isArray(t.position)&&t.$el){let s=t.$el.getDimensions();return p()(e.x,e.y,e.width,e.height,s.x,s.y,s.width,s.height)}return!1}).map(e=>e.selected=!0),this.edges.filter(t=>Array.isArray(t.position1)&&Array.isArray(t.position2)&&m()(e.x,e.y,e.width,e.height,t.position1[0],t.position1[1],t.position2[0],t.position2[1])).map(e=>e.selected=!0)},toJSON(){let e=this.export();return JSON.stringify(e,null,2)},async onDocumentMouseUp(e){if(!this.parameterViewer&&(this.selectedSideEdge&&this.selectEdge(this.selectedSideEdge,null),this.state.selecting&&(this.multiSelect(),this.state.selecting=null),this.state.moving&&(this.state.moving=null),this.state.editable&&this.state.linkFrom)){if(1==e.which&&this.state.linkTo)try{await this.addEdge(this.state.linkFrom,this.state.linkTo)}catch(t){this.$emit("error",t)}this.unlink()}},async onKeyDown(e){if(this.parameterViewer)return;var t=document.querySelectorAll("input, textarea, button, select, datalist");for(let r of t)if(r===document.activeElement)return;let s=!1;if(this.state.editable)if("Delete"===e.code)this.deleteSelected(),s=!0;else if(e.ctrlKey||e.metaKey)if("KeyV"===e.code){if(!navigator||!navigator.clipboard||"function"!==typeof navigator.clipboard.readText)return void this.$emit("error","Pasting is not supported by your browser.");if(this.hasSelection&&this.clipboard){if(this.clipboard.edges.length>0)return void this.$emit("error","Pasting edges is not supported yet.");this.clipboard.blocks.length>0&&this.clipboard.blocks.forEach(e=>{"process"===e.type&&"schema"!==e.origin?this.duplicate(n.A.pickFromObject(e,["arguments","description","namespace","position","process_id"])):this.$emit("error",`Pasting block '${e.id}' is not supported.`)})}else try{const e=await navigator.clipboard.readText();let t=JSON.parse(e);await this.import(t)}catch(i){this.$emit("error",i,"Paste Error")}s=!0}else if("KeyC"===e.code){if(!navigator||!navigator.clipboard||"function"!==typeof navigator.clipboard.writeText)return void this.$emit("error","Copying is not supported by your browser.");if(this.hasSelection)this.clipboard={blocks:this.selectedBlocks.slice(0),edges:this.selectedEdges.slice(0)};else try{let e=this.toJSON();await navigator.clipboard.writeText(e),s=!0}catch(i){this.$emit("error",i,"Copy Error")}s=!0}s&&(e.preventDefault(),e.stopPropagation())},onMouseWheel(e){if(!this.parameterViewer&&(!this.explicitZoom||this.hasFocus||e.ctrlKey||e.metaKey)){let r=this.getMousePos(e);var t=r[0]-this.state.center[0],s=r[1]-this.state.center[1],i=Math.pow(1.1,-1*Math.sign(e.deltaY));this.moveCenter(-t*(i-1),-s*(i-1)),this.state.scale*=i,e.preventDefault(),this.showZoomInfo=!1}},domBoundingBox(e){var t=e.getBoundingClientRect();return t.offsetTop=t.top+Math.max(document.documentElement.scrollTop,document.body.scrollTop),t.offsetLeft=t.left+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),t},getMousePos(e){let t=this.$refs.div.getBoundingClientRect();return[e.clientX-t.left,e.clientY-t.top]},onMouseMove(e){if(!this.parameterViewer)try{let r=this.getMousePos(e);if(this.state.editable&&this.selectedSideEdge){var t=this.selectedSideEdge.selectedParameter.getCirclePosition();if(t){var s=Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2));s>10&&(this.link(this.selectedSideEdge.selectedParameter),this.removeEdge(this.selectedSideEdge),this.commit())}}if(this.state.selecting&&(this.state.selecting.current=r),this.state.moving&&(this.moveCenter(r[0]-this.state.moving[0],r[1]-this.state.moving[1]),this.state.moving=r),this.state.linkFrom){var i=this.state.linkFrom.getCirclePosition();i&&(this.linkingLine={x1:i[0],y1:i[1],x2:r[0],y2:r[1],stroke:"rgba(0,0,0,0.4)","stroke-width":3*this.state.scale})}}catch(r){this.$emit("error",r)}},onMouseDown(e){if(this.parameterViewer)return;let t=null,s=this.getMousePos(e);if(1==e.which)for(var i of(e.shiftKey?this.state.selecting={start:s,current:s}:this.unselectAll(),this.edges))if(i.$el){var r=i.$el.collide(s[0],s[1]);if(0!=r){if(0!==this.selectedEdges.length||e.shiftKey||(r<.3?t=i.parameter2:r>.7&&(t=i.parameter1)),this.selectEdge(i,!0,t),i.issues.length>0)for(let e of i.issues)this.$emit("error",e);e.preventDefault();break}}2!=e.which&&(1!=e.which||t||e.shiftKey)||(this.state.moving=s),this.focus()},getDimensions(){return this.domBoundingBox(this.$refs.div)},async clear(){return await this.startTransaction(async()=>(this.edges=[],this.blocks=this.blocks.filter(e=>"parameter"===e.type&&n.A.isObject(e.spec)&&"schema"===e.origin),this.nextBlockId=1,this.nextEdgeId=1,this.process={},this.updateHiddenParameterRefEdges(),!0))},commit(e=null,t=!0,s=!0){this.activeTransactions>0||(!1!==t&&this.saveHistory(),!1!==s?(this.$emit("input",null===e?this.export():e),this.updateHiddenParameterRefEdges()):this.refreshEdges())},saveHistory(){var e=this.export(!0);this.history.splice(this.historyPointer+1,this.historySize,Object.freeze(e)),this.history.length>this.historySize&&this.history.shift(),this.historyPointer=this.history.length-1,this.$emit("historyChanged",this.history,this.historyPointer)},async undo(){await this.historyStep(-1)},async redo(){await this.historyStep(1)},async historyStep(e){var t=this.historyPointer+e,s=this.history[t];s&&(this.historyPointer=t,this.import(s,{saveHistory:!1,undoOnError:!1,perfectScale:!1}),this.$emit("historyChanged",this.history,this.historyPointer))},setResultNode(e,t=!0){if(e=this.getBlockById(e.id),e&&e.result!==t){this.updateBlockResult(e,t);var s=!1,i=!1;for(var r of this.processBlocks)if(!e||r.id!==e.id)if(i=!0,t)this.updateBlockResult(r,!1);else if(r.$el&&!r.$el.hasOutputEdges()){this.updateBlockResult(r,!0),s=!0;break}!i||t||s||this.$emit("error","No result node available, please specify one.")}},getPositionForPageXY(e,t){var s=this.getDimensions();return null!==e&&(e=(e-s.offsetLeft-this.state.center[0])/this.state.scale),null!==t&&(t=(t-s.offsetTop-this.state.center[1])/this.state.scale),[e,t]},duplicate(e){e=n.A.deepClone(e),e.position&&(e.position[1]+=100);let t=this.addBlock(e);this.$nextTick(()=>this.createEdgesForArguments(t.id,e.arguments))},addProcess(e,t={},s=[],i=null){return this.addBlock({process_id:e,namespace:i,arguments:t,position:s})},addBlock(e,t=null){let s=String(this.incrementId(t));null===t&&n.A.hasText(e.process_id)?(t=e.process_id.replace(/^([a-z]*).*$/i,"$1")+s,this.getBlockById("#"+t)&&(t=s)):t=s,"function"===typeof e.toJSON&&(e=e.toJSON());var i={id:"#"+t,type:"process",selected:!1,position:e.position,process_id:e.process_id,namespace:e.namespace,arguments:e.arguments,description:e.description||null,result:e.result||!1};this.processRegistry&&(i.spec=this.processRegistry.get(e.process_id,e.namespace));var r=this.getBlockSize(i);return i.position=n.A.ensurePoint(i.position,()=>this.getNewBlockDefaultPosition(r)),i.result&&this.blocks.filter(e=>!0===e.result).length?delete i.result:0===this.processBlocks.length&&(i.result=!0),this.blocks.push(h.Ay.observable(i)),this.commit(),i},getNewBlockDefaultPosition(e){var t=this.getDimensions(),s=[(-this.state.center[0]+t.width/2)/this.state.scale-e[0]/2+this.newBlockOffset,(-this.state.center[1]+t.height/2)/this.state.scale-e[1]/2+this.newBlockOffset];return this.newBlockOffset<150&&(this.newBlockOffset+=10),s},getBlockSize(e){if(e.$el){let t=e.$el.getDimensions();return[t.width/this.state.scale,t.height/this.state.scale]}let t,s=Math.max(n.A.size(e.arguments),n.A.isObject(e.spec)?n.A.size(e.spec.parameters):0),i=g.A.blockWidth;t=s>0?this.state.compactMode?i.compactParams:i.normalParams:this.state.compactMode?i.compact:i.normal;let r="string"===typeof e.description?40:0,o=y+15*s+r;return[t,o]},moveCenter(e,t,s=!1){var i=this.getDimensions();this.state.center=[(s?i.width/2:this.state.center[0])+e,(s?i.height/2:this.state.center[1])+t],this.newBlockOffset=0},unselectAll(){for(var e of this.blocks)this.updateBlockSelected(e,!1,!1);for(var t of this.edges)this.selectEdge(t,!1)},selectEdge(e,t=!0,s=null){return n.A.isObject(e)||(e=this.edges[e]),e.selected!==t&&(null!==t&&this.$set(e,"selected",t),this.$set(e,"selectedParameter",s),!0)},removeEdge(e){e.parameter1.eraseEdge(e),e.parameter2.eraseEdge(e),this.$delete(this.edges,this.edges.indexOf(e))},async removeBlock(e){if("parameter"===e.type){let t=null,s=this.blocks.find(s=>(t=s.$el.hiddenParameterRef(e),null!==t));if(s)throw new Error(`Parameter is still used in '${s.id}', parameter '${t}'. Only unused parameters can be deleted.`)}return await this.startTransaction(async()=>{var t=this.blocks.findIndex(t=>t.id==e.id);if(t<0)return!1;for(var s of this.edges.slice(0))s.parameter1.$parent.id!==e.id&&s.parameter2.$parent.id!==e.id||this.removeEdge(s);return e.result&&this.setResultNode(e,!1),this.$delete(this.blocks,t),!0})},getBlockById(e){var t=this.blocks.filter(t=>t.id===e);return t.length>0?t[0]:null},async deleteSelected(){return!!this.hasSelection&&await this.startTransaction(async()=>{for(var e of this.selectedBlocks.slice(0))e.$el.allowsDelete&&await this.removeBlock(e);for(var t of this.selectedEdges.slice(0))this.removeEdge(t);return!0})},async addEdgeByNames(e,t,s,i){var r=[];for(var o of[e,s]){var a=this.getBlockById(o);if(!a)throw"Can't find block: "+o;if(!a.$el)throw"Block not mounted yet: "+o;r.push(a.$el)}await this.addEdge(r[0].getBlockParameter(t),r[1].getBlockParameter(i))},async addEdge(e,t){if(!e||!t)throw"One of the parameters is invalid.";if(e!=t){if(e.$parent==t.$parent)throw"You can't link a block to itself";var s=this.nextEdgeId++,i={id:s,selected:!1,inactive:!1,issues:[],$el:null};if(e.output?(i.parameter1=e,i.parameter2=t):(i.parameter1=t,i.parameter2=e),i.parameter1.output===i.parameter2.output)throw"You have to link an input with an output";if(-1!==this.allSuccessors(i.parameter1).indexOf(i.parameter2.id))throw"You can not create a loop";if(i.parameter2.getEdgeCount()>0&&!i.parameter2.allowsMultipleInputs)throw"Parameter accepts only one input";for(var r of this.edges)if(r.$el&&r.$el.equals(i))throw"This connection exists already";if(!c.JsonSchemaValidator.isSchemaCompatible(i.parameter2.schema||{},i.parameter1.schema||{},!1,!0)){let e='Incoming data type is not compatible for parameter "'+i.parameter2.name+'"';i.issues.push(e),this.$emit("error",e)}return await this.startTransaction(async()=>(this.unlink(),this.edges.push(h.Ay.observable(i)),i.parameter1.addEdge(i),i.parameter2.addEdge(i),this.setResultNode(i.parameter1.$parent,!1),!0))}},allSuccessors(e){var t=e.$parent,s={},i=[t];s[t.id]=!0;while(i.length>0){var r=i.pop();for(var o in r.edges)for(var a in r.edges[o]){var n=r.edges[o][a];if(n.block1==r){var l=n.block2;l.id in s||(s[l.id]=!0,i.push(l))}}}return Object.values(s)},async toggleCompact(){this.state.compactMode=!this.state.compactMode,this.$emit("compactMode",this.state.compactMode),await this.$nextTick(),this.refreshEdges()},export(e=!1){let t={process_graph:{}};for(let s of this.processBlocks){let i=["process_id","namespace","arguments","description","result"];e&&i.push("position");let r=n.A.pickFromObject(s,i);null===r.description&&delete r.description,!0!==r.result&&delete r.result,r.namespace||delete r.namespace;let o=s.id.substr(1);t.process_graph[o]=r}if(!this.parent){t.parameters=[];let e=this.getPgParameters();for(let s of e)t.parameters.push(s.spec)}return new v(Object.assign({},this.process,t))},async startTransaction(e,t={},...s){let i;this.activeTransactions++;try{i=await e(s)}catch(r){if(this.$emit("error",r,"Model is invalid"),!1!==t.undoOnError)try{await this.undo()}catch(o){this.$emit("error",r,"Revert failed")}i=!1}return this.activeTransactions--,this.commit(null,t.saveHistory,t.propagate),i},async import(e,t={}){return await this.startTransaction(async()=>{if(!1!==t.clear&&(await this.clear(),this.process=e instanceof c.ProcessGraph?e.toJSON():e),!n.A.isObject(e))return!1;let s;return e instanceof c.ProcessGraph?(s=new c.ProcessGraph(e.toJSON(),this.processRegistry),s.setParent(e.parentProcessId,e.parentParameterName)):s=new c.ProcessGraph(e,this.processRegistry),s.allowEmpty(),s.parse(),this.processGraph=Object.freeze(s),await this.importPgParameters(this.processGraph.getProcessParameters(!0),"user",!1!==t.clear),await this.importNodes(this.processGraph.getStartNodes()),await this.importEdges(this.processGraph),!1!==t.perfectScale&&this.perfectScale(),this.$nextTick(()=>this.updateHiddenParameterRefEdges()),!0},t)},async importPgParameters(e,t,s=!0){if(!Array.isArray(e))return;let i={undoOnError:!1,saveHistory:!1,propagate:!1};return await this.startTransaction(async()=>{s&&(this.blocks=this.blocks.filter(e=>"parameter"!==e.type||e.origin!==t));let i=this.getBlockSize({}),r=[0,0];for(var o in e)r=[-i[0]-y,o*(i[1]+y)],await this.addPgParameter(e[o],t,r)},i)},async addPgParameter(e,t="user",s=null){return await this.startTransaction(async()=>{let i="$"+e.name;return!(this.blocks.findIndex(e=>"parameter"===e.type&&e.id==i)>=0)&&(e=n.A.deepClone(e),"undefined"===typeof e.schema&&(e.schema={}),this.blocks.push(h.Ay.observable({id:i,type:"parameter",origin:t,position:n.A.ensurePoint(s,()=>this.getNewBlockDefaultPosition(this.getBlockSize({}))),spec:Object.freeze(e)})),!0)})},getPgParameters(){return this.blocks.filter(e=>"parameter"===e.type)},getPgParameterById(e){return this.blocks.find(t=>"parameter"===t.type&&t.id===e)},async importEdges(e){var t=e.getNodes();return Promise.all(Object.values(t).map(e=>this.importEdgesForNode(e)))},async importEdgesForNode(e){var t=e.getArgumentNames();for(let s in t){let i=t[s],r=e.getRawArgument(i),o="#"+e.id;switch(e.getArgumentType(i)){case"result":await this.addEdgeByNames("#"+r.from_node,"output",o,i,!1);break;case"parameter":await this.addEdgeByNames("$"+r.from_parameter,"output",o,i,!1);break;case"object":case"array":await this.importEdgeDeep(r,o,i);break}}},async importEdgeDeep(e,t,s){for(let i in e)if(e[i]&&"object"===typeof e[i]&&"process_graph"!==i)await this.importEdgeDeep(e[i],t,s);else{if(!n.A.isRef(e))continue;e.from_node?await this.addEdgeByNames("#"+e.from_node,"output",t,s,!1):e.from_parameter&&await this.addEdgeByNames("$"+e.from_parameter,"output",t,s,!1)}},async createEdgesForArguments(e,t){for(let s in t)await this.importEdgeDeep(t[s],e,s)},async importNodes(e,t=0,s=0,i=[]){let r=[],o=0;for(let a of e){if(i.includes(a.id)||void 0!==a.getPreviousNodes().find(e=>!i.includes(e.id))){s+=y/2;continue}let e="function"===typeof a.toJSON?a.toJSON():a;e.position=n.A.ensurePoint(e.position,()=>[t,s]);let l=this.addBlock(e,a.id);i.push(a.id);let c=this.getBlockSize(l);o=Math.max(o,e.position[0]+c[0]),s=e.position[1]+c[1]+y,r=r.concat(a.getNextNodes())}r.length&&await this.importNodes(r,o+y,0,i)},incrementId(e=null){"number"===typeof e||"string"===typeof e&&0!==e.length||(e=this.nextBlockId,this.nextBlockId++);let t=Number.parseInt(e,10);return Number.isNaN(t)||(this.nextBlockId=Math.max(this.nextBlockId,t+1)),e},perfectScale(){if(this.$refs.div&&0!==this.blocks.length){var e=null,t=null,s=null,i=null;for(let r of this.blocks){let o=this.getBlockSize(r),a=n.A.ensurePoint(r.position);null==e?(e=a[0]-15,t=a[0]+o[0]+15,s=a[1]-15,i=a[1]+o[1]+15):(e=Math.min(e,a[0]-15),t=Math.max(t,a[0]+o[0]+15),s=Math.min(s,a[1]-15),i=Math.max(i,a[1]+o[1]+15))}var r=this.$refs.div.getBoundingClientRect(),o=r.width/(t-e),a=r.height/(i-s);this.state.scale=Math.min(o,a,1.5),this.state.center=[r.width/2-this.state.scale*(e+t)/2,r.height/2-this.state.scale*(s+i)/2],this.newBlockOffset=0}},showParameterViewer(e,t,s,i,r,o,a){this.parameterViewer={parameters:e,values:t,title:s,selectParameterName:r,parent:a}}}};class v{constructor(e){Object.assign(this,e)}}const w=k;var P=s(1656);function E(e){var t=s(9361);t.__inject__&&t.__inject__(e)}var B=(0,P.A)(w,i,r,!1,E,null,null,!0);const $=B.exports},9361:(e,t,s)=>{"use strict";s.r(t);var i=s(3617),r={};for(const o in i)"default"!==o&&(r[o]=()=>i[o]);s.d(t,r)},9541:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>l});var i=s(1601),r=s.n(i),o=s(6314),a=s.n(o),n=a()(r());n.push([e.id,".vue-component.model-builder{width:100%;height:100%;position:relative}.vue-component.model-builder.editable.focus .blocks{border-color:#1666b64d}.vue-component.model-builder .blocks:focus,.vue-component.model-builder .canvas:focus,.vue-component.model-builder:focus{outline:0}.vue-component.model-builder .canvas{width:100%;height:100%;position:absolute;z-index:1}.vue-component.model-builder .blocks{box-sizing:border-box;border:1px solid #0000;overflow:hidden;position:absolute;z-index:3;width:100%;height:100%}.vue-component.model-builder.compact .blockId,.vue-component.model-builder.compact .blockicon .addDescription,.vue-component.model-builder.compact .blockicon .delete,.vue-component.model-builder.compact .blockicon .info,.vue-component.model-builder.compact .editDescription,.vue-component.model-builder.scale_s .blockicon,.vue-component.model-builder.scale_xs .blockicon,.vue-component.model-builder.scale_xs .connector .text{display:none}.vue-component.model-builder .zoomInfo{position:absolute;top:0;right:0;display:inline-block;padding:.3em;background-color:#f9f9f9;color:#000;border-radius:0 0 0 .3em;z-index:5}.vue-component.model-builder.scale_xs .editDescription{visibility:hidden}",""]);const l=n}}]);
//# sourceMappingURL=openeo.4953.min.js.map